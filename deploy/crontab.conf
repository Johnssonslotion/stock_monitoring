# Cron Job Configuration for Pre-flight Health Check

# Run pre-flight health check every day at 08:30 KST (30 minutes before market open)
# This ensures all systems are operational before data collection begins

# Installation:
# crontab -e
# Add the following line (adjust path as needed):

# Daily Pre-flight Check (08:30 KST)
30 8 * * * cd /app && /usr/bin/python3 scripts/preflight_check.py >> /app/logs/preflight_$(date +\%Y\%m\%d).log 2>&1

# Post-Market Database Optimization (16:00 KST)
0 16 * * * cd /app && /usr/bin/python3 scripts/timescaledb_maintenance.py >> /app/logs/db_optimize_$(date +\%Y\%m\%d).log 2>&1

# [ISSUE-044] Unified Recovery via VerificationConsumer (16:00 KST)
# Legacy RecoveryOrchestrator deprecated - recovery now handled by verification-worker
# Recovery is automatic via RealtimeVerifier gap detection during market hours
# Post-market batch verification triggers recovery tasks to verification-consumer
0 16 * * * docker exec verification-worker python -c "from src.verification.worker import VerificationProducer; import asyncio; asyncio.run(VerificationProducer().produce_daily_tasks())" >> /home/ubuntu/workspace/stock_monitoring/logs/recovery_$(date +\%Y\%m\%d).log 2>&1

# ============================================
# [RFC-009] Post-US-Market Deployment & Migration
# US Market Close: 16:00 ET = 21:00 UTC (EST) / 06:00 KST+1
# Schedule: 21:30 UTC (30분 여유) = 06:30 KST+1
# ============================================

# Post-US-Market: Container Restart & Migration (06:30 KST = 21:30 UTC)
30 21 * * * cd /home/ubuntu/workspace/stock_monitoring && make up-prod --force-emergency >> /home/ubuntu/workspace/stock_monitoring/logs/deploy_$(date +\%Y\%m\%d).log 2>&1

# Post-US-Market: DB Migration (06:35 KST = 21:35 UTC, 5분 후 컨테이너 안정화 대기)
35 21 * * * cd /home/ubuntu/workspace/stock_monitoring && ./scripts/db/migrate.sh up >> /home/ubuntu/workspace/stock_monitoring/logs/migrate_$(date +\%Y\%m\%d).log 2>&1

# Alternative: Run with email notification on failure
# 30 8 * * * cd /home/ubuntu/workspace/stock_monitoring && /usr/bin/python3 scripts/preflight_check.py || echo "Pre-flight check failed! Check logs." | mail -s "Market Data System Alert" admin@example.com

# Weekly system health report (every Monday at 08:00)
# 0 8 * * 1 cd /home/ubuntu/workspace/stock_monitoring && /usr/bin/python3 scripts/weekly_report.py

# Notes:
# - Ensure Python environment is activated if using virtualenv
# - Ensure proper permissions: chmod +x scripts/preflight_check.py
# - Logs are saved to logs/preflight_YYYYMMDD.log
# - Check cron logs: grep CRON /var/log/syslog
