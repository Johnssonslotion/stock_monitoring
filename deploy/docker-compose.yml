services:
  redis:
    image: redis:7-alpine
    container_name: ${COMPOSE_PROJECT_NAME}-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      default:
        aliases:
          - redis
          - redis

  tick-archiver:
    build: ..
    container_name: tick-archiver
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - REDIS_URL=redis://redis:6379
      - APP_ENV=${APP_ENV}
    command: python -m src.data_ingestion.ticks.archiver
    restart: unless-stopped
    volumes:
      - ${BASE_PATH}/data:/app/data

  # [RFC-007] KIS Service (Unified)
  kis-service:
    build:
      context: ..
      dockerfile: Dockerfile
    command: python -m src.data_ingestion.instances.kis_main
    profiles: [ "collection", "real" ]
    volumes:
      - ../src:/app/src
      - ${BASE_PATH}/configs:/app/configs
      - ${BASE_PATH}/data/raw/kis:/app/data/raw/kis
    env_file:
      - ../${ENV_FILE:-.env.prod}
    depends_on:
      - redis
      - timescaledb
    restart: always
    deploy:
      resources:
        reservations:
          memory: 512M
        limits:
          memory: 2G

  # [RFC-007] Kiwoom Service (Isolated Sub)
  kiwoom-service:
    build:
      context: ..
      dockerfile: Dockerfile
    command: python -m src.data_ingestion.instances.kiwoom_sub
    profiles: [ "collection", "real" ]
    volumes:
      - ../src:/app/src
      - ${BASE_PATH}/data/raw/kiwoom:/app/data/raw/kiwoom
      - ${BASE_PATH}/configs:/app/configs
    env_file:
      - ../${ENV_FILE:-.env.prod}
    depends_on:
      - redis
    restart: always
    deploy:
      resources:
        reservations:
          memory: 512M
        limits:
          memory: 2G

  timescaledb:
    image: timescale/timescaledb:latest-pg16
    container_name: ${COMPOSE_PROJECT_NAME}-timescale
    environment:
      - POSTGRES_PASSWORD=password
      - POSTGRES_USER=postgres
      - POSTGRES_DB=${DB_NAME:-stockval}
    ports:
      - "5432:5432"
    volumes:
      - timescale-data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      default:
        aliases:
          - timescaledb
          - timescaledb

  # Archiver: TimescaleDB
  timescale-archiver:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: timescale-archiver
    command: python -m src.data_ingestion.archiver.timescale_archiver
    environment:
      - REDIS_URL=redis://redis:6379/0
      - APP_ENV=${APP_ENV}
      - DB_HOST=timescaledb
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=password
      - DB_NAME=${DB_NAME:-stockval}
      - PYTHONUNBUFFERED=1
    depends_on:
      redis:
        condition: service_healthy
      timescaledb:
        condition: service_started
    networks:
      - default
    volumes:
      - ../src:/app/src
    restart: unless-stopped # CRITICAL: Auto-restart on crash

  # History Loader (One-off)
  history-loader:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: history-loader
    command: python -m src.data_ingestion.history.loader
    env_file:
      - ../${ENV_FILE:-.env}
    environment:
      - APP_ENV=${APP_ENV}
      - DB_HOST=timescaledb
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=password
      - DB_NAME=${DB_NAME:-stockval}
      - PYTHONUNBUFFERED=1
    volumes:
      - ../configs:/app/configs
      - ../data:/app/data
      - ../src:/app/src
    depends_on:
      timescaledb:
        condition: service_started
    networks:
      - default

  # API Server (WebSocket)
  api-server:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME}-api
    command: python -m uvicorn src.api.main:app --host 0.0.0.0 --port 8000
    environment:
      - REDIS_URL=redis://redis:6379/0
      - APP_ENV=${APP_ENV}
      - DB_HOST=timescaledb
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=password
      - DB_NAME=${DB_NAME:-stockval}
      - API_AUTH_SECRET=${API_AUTH_SECRET:-super-secret-key}
      - PYTHONUNBUFFERED=1
      - ENV_TYPE=${ENV_TYPE}
    ports:
      - "${API_PORT:-8000}:8000" # X-API-Key 인증으로 보안 유지
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - default
    volumes:
      - ../configs:/app/configs
      - ../src:/app/src

  # Data Ingestion: News
  news-collector:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: news-collector
    command: python -m src.data_ingestion.news.collector
    environment:
      - REDIS_URL=redis://redis:6379/0
      - APP_ENV=${APP_ENV}
      - PYTHONUNBUFFERED=1
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - default

  # Archiver: News
  news-archiver:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: news-archiver
    command: python -m src.data_ingestion.news.archiver
    environment:
      - REDIS_URL=redis://redis:6379/0
      - APP_ENV=${APP_ENV}
      - PYTHONUNBUFFERED=1
    volumes:
      - ../data:/app/data
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - default

  history-collector:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: history-collector
    command: python -m src.data_ingestion.history.main
    env_file:
      - ../${ENV_FILE:-.env.prod}
    environment:
      - REDIS_URL=redis://redis:6379/0
      - APP_ENV=${APP_ENV}
      - DB_HOST=timescaledb
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=password
      - DB_NAME=${DB_NAME:-stockval}
      - PYTHONUNBUFFERED=1
    volumes:
      - ../configs:/app/configs
    depends_on:
      timescaledb:
        condition: service_started
    networks:
      - default
    profiles:
      - history

  # Sentinel (Monitoring & Alerting) - NEW
  sentinel-agent:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: sentinel-agent
    command: python -m src.monitoring.sentinel
    environment:
      - REDIS_URL=redis://redis:6379/0
      - APP_ENV=${APP_ENV}
      - PYTHONUNBUFFERED=1
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - default
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ../src:/app/src
    restart: unless-stopped
    # Prioritize Sentinel Survival
    oom_score_adj: -500
    deploy:
      resources:
        reservations:
          cpus: '0.1'
          memory: 256M
        limits:
          memory: 512M
    profiles:
      - real
      - sentinel

  # Dashboard UI (React + Vite) - NEW
  dashboard-ui:
    image: node:20-slim
    container_name: ${COMPOSE_PROJECT_NAME}-ui
    working_dir: /app/src/web
    volumes:
      - ..:/app
    # dev 서버 실행 (host 0.0.0.0으로 외부 접근 허용)
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    ports:
      - "${WEB_PORT:-5173}:5173"
    depends_on:
      - api-server
    environment:
      - VITE_API_PORT=${API_PORT:-8000}
      - VITE_ENV_TYPE=${ENV_TYPE}
    networks:
      - default
    profiles:
      - real
      - ui

  # Recovery Worker (New)
  recovery-worker:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: recovery-worker
    command: sleep infinity
    env_file:
      - ../${ENV_FILE:-.env.prod}
    volumes:
      - ${BASE_PATH}/data:/app/data
      - ${BASE_PATH}/configs:/app/configs
      - ../src:/app/src
      - ../scripts:/app/scripts
    environment:
      - DB_HOST=timescaledb
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=password
      - DB_NAME=${DB_NAME:-stockval}
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - timescaledb
    networks:
      - default
    restart: always
    deploy:
      resources:
        reservations:
          memory: 256M
        limits:
          memory: 1G
    profiles:
      - real

  # Verification Worker (Automated Quality Gate) [ISSUE-036 Extension]
  verification-worker:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: verification-worker
    command: python -m src.verification.worker
    env_file:
      - ../${ENV_FILE:-.env.prod}
    environment:
      - DB_HOST=timescaledb
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=password
      - DB_NAME=${DB_NAME:-stockval}
      - REDIS_URL=redis://redis:6379/1
    volumes:
      - ../src:/app/src
      - ../configs:/app/configs
      - ${BASE_PATH}/data:/app/data
    depends_on:
      - timescaledb
      - redis
    networks:
      - default
    restart: always
    deploy:
      resources:
        reservations:
          memory: 256M
        limits:
          memory: 1G
    profiles:
      - real
      - verification

volumes:
  redis-data:
  timescale-data:
