services:
  redis:
    image: redis:7-alpine
    container_name: ${COMPOSE_PROJECT_NAME}-redis
    # Security: No external port binding - internal network only
    # ports:
    #   - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      default:
        aliases:
          - redis

  # [Council 2차 결정] Redis Gatekeeper - Rate Limiter 전용 (물리적 분리)
  redis-gatekeeper:
    image: redis:7-alpine
    container_name: ${COMPOSE_PROJECT_NAME}-redis-gatekeeper
    # Security: No external port binding - internal network only
    # ports:
    #   - "${REDIS_GATEKEEPER_PORT:-6381}:6379"
    volumes:
      - redis-gatekeeper-data:/data
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      default:
        aliases:
          - redis-gatekeeper
    deploy:
      resources:
        limits:
          memory: 256M

  tick-archiver:
    build: ..
    container_name: tick-archiver
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - REDIS_URL=redis://redis:6379
      - APP_ENV=${APP_ENV}
    command: python -m src.data_ingestion.ticks.archiver
    restart: unless-stopped
    volumes:
      - ${BASE_PATH}/data:/app/data

  # [RFC-007] KIS Service (Unified)
  kis-service:
    build:
      context: ..
      dockerfile: Dockerfile
    command: python -m src.data_ingestion.instances.kis_main
    profiles: [ "collection", "real" ]
    volumes:
      - ../src:/app/src
      - ${BASE_PATH}/configs:/app/configs
      - ${BASE_PATH}/data/raw/kis:/app/data/raw/kis
    env_file:
      - ../${ENV_FILE:-.env.prod}
    depends_on:
      - redis
      - timescaledb
    restart: always
    deploy:
      resources:
        reservations:
          memory: 512M
        limits:
          memory: 2G

  # [RFC-007] Kiwoom Service (Isolated Sub)
  kiwoom-service:
    build:
      context: ..
      dockerfile: Dockerfile
    command: python -m src.data_ingestion.instances.kiwoom_sub
    profiles: [ "collection", "real" ]
    volumes:
      - ../src:/app/src
      - ${BASE_PATH}/data/raw/kiwoom:/app/data/raw/kiwoom
      - ${BASE_PATH}/configs:/app/configs
    env_file:
      - ../${ENV_FILE:-.env.prod}
    depends_on:
      - redis
    restart: always
    deploy:
      resources:
        reservations:
          memory: 512M
        limits:
          memory: 2G

  timescaledb:
    image: timescale/timescaledb:latest-pg16
    container_name: ${COMPOSE_PROJECT_NAME}-timescale
    environment:
      - POSTGRES_PASSWORD=password
      - POSTGRES_USER=postgres
      - POSTGRES_DB=${DB_NAME:-stockval}
    # Optional: Expose port for external DB tools (DBeaver, pgAdmin, etc.)
    # For production, consider removing this and use SSH tunnel instead
    ports:
      - "5432:5432"
    volumes:
      - timescale-data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      default:
        aliases:
          - timescaledb
          - timescaledb

  # Archiver: TimescaleDB
  timescale-archiver:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: timescale-archiver
    command: python -m src.data_ingestion.archiver.timescale_archiver
    environment:
      - REDIS_URL=redis://redis:6379/0
      - APP_ENV=${APP_ENV}
      - DB_HOST=timescaledb
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=password
      - DB_NAME=${DB_NAME:-stockval}
      - PYTHONUNBUFFERED=1
    depends_on:
      redis:
        condition: service_healthy
      timescaledb:
        condition: service_started
    networks:
      - default
    volumes:
      - ../src:/app/src
    restart: unless-stopped # CRITICAL: Auto-restart on crash

  # History Loader (One-off)
  history-loader:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: history-loader
    command: python -m src.data_ingestion.history.loader
    env_file:
      - ../${ENV_FILE:-.env}
    environment:
      - APP_ENV=${APP_ENV}
      - DB_HOST=timescaledb
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=password
      - DB_NAME=${DB_NAME:-stockval}
      - PYTHONUNBUFFERED=1
    volumes:
      - ../configs:/app/configs
      - ../data:/app/data
      - ../src:/app/src
    depends_on:
      timescaledb:
        condition: service_started
    networks:
      - default

  # API Server (WebSocket)
  api-server:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME}-api
    command: python -m uvicorn src.api.main:app --host 0.0.0.0 --port 8000
    environment:
      - REDIS_URL=redis://redis:6379/0
      - APP_ENV=${APP_ENV}
      - DB_HOST=timescaledb
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=password
      - DB_NAME=${DB_NAME:-stockval}
      - API_AUTH_SECRET=${API_AUTH_SECRET:-super-secret-key}
      - PYTHONUNBUFFERED=1
      - ENV_TYPE=${ENV_TYPE}
    ports:
      - "${API_PORT:-8000}:8000" # X-API-Key 인증으로 보안 유지
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - default
    volumes:
      - ../configs:/app/configs
      - ../src:/app/src

  # Data Ingestion: News
  news-collector:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: news-collector
    command: python -m src.data_ingestion.news.collector
    environment:
      - REDIS_URL=redis://redis:6379/0
      - APP_ENV=${APP_ENV}
      - PYTHONUNBUFFERED=1
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - default

  # Archiver: News
  news-archiver:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: news-archiver
    command: python -m src.data_ingestion.news.archiver
    environment:
      - REDIS_URL=redis://redis:6379/0
      - APP_ENV=${APP_ENV}
      - PYTHONUNBUFFERED=1
    volumes:
      - ../data:/app/data
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - default

  history-collector:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: history-collector
    command: python -m src.data_ingestion.history.main
    env_file:
      - ../${ENV_FILE:-.env.prod}
    environment:
      - REDIS_URL=redis://redis:6379/0
      - APP_ENV=${APP_ENV}
      - DB_HOST=timescaledb
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=password
      - DB_NAME=${DB_NAME:-stockval}
      - PYTHONUNBUFFERED=1
    volumes:
      - ../configs:/app/configs
    depends_on:
      timescaledb:
        condition: service_started
    networks:
      - default
    profiles:
      - history

  # Sentinel (Monitoring & Alerting) - NEW
  sentinel-agent:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: sentinel-agent
    command: python -m src.monitoring.sentinel
    environment:
      - REDIS_URL=redis://redis:6379/0
      - APP_ENV=${APP_ENV}
      - PYTHONUNBUFFERED=1
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - default
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ../src:/app/src
    restart: unless-stopped
    # Prioritize Sentinel Survival
    oom_score_adj: -500
    deploy:
      resources:
        reservations:
          cpus: '0.1'
          memory: 256M
        limits:
          memory: 512M
    profiles:
      - real
      - sentinel

  # Dashboard UI (React + Vite) - NEW
  dashboard-ui:
    image: node:20-slim
    container_name: ${COMPOSE_PROJECT_NAME}-ui
    working_dir: /app/src/web
    volumes:
      - ..:/app
    # dev 서버 실행 (host 0.0.0.0으로 외부 접근 허용)
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    ports:
      - "${WEB_PORT:-5173}:5173"
    depends_on:
      - api-server
    environment:
      - VITE_API_PORT=${API_PORT:-8000}
      - VITE_ENV_TYPE=${ENV_TYPE}
    networks:
      - default
    profiles:
      - real
      - ui

  # Recovery Worker (RFC-009 Compliant)
  recovery-worker:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: recovery-worker
    # RFC-009: Use actual recovery script with Self-Diagnosis
    command: bash -c "python -c 'from src.data_ingestion.recovery.backfill_manager import BackfillManager; print(\"Self-Diagnosis passed, ready for cron-triggered recovery\")' && sleep infinity"
    env_file:
      - ../${ENV_FILE:-.env.prod}
    volumes:
      - ${BASE_PATH}/data:/app/data
      - ${BASE_PATH}/configs:/app/configs
      - ../src:/app/src
      - ../scripts:/app/scripts
    environment:
      - DB_HOST=timescaledb
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=password
      - DB_NAME=${DB_NAME:-stockval}
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - timescaledb
      - redis
    networks:
      - default
    restart: always
    # RFC-009: Healthcheck verifies Self-Diagnosis and Redis connectivity
    healthcheck:
      test: [ "CMD", "python", "-c", "import redis; r = redis.Redis.from_url('redis://redis:6379/1'); r.ping(); print('healthy')" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        reservations:
          memory: 256M
        limits:
          memory: 1G
    profiles:
      - real

  # Verification Worker (Automated Quality Gate) [ISSUE-036 Extension]
  # ISSUE-041: Now uses API Hub for all REST API calls
  verification-worker:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: verification-worker
    command: python -m src.verification.worker
    env_file:
      - ../${ENV_FILE:-.env.prod}
    environment:
      - DB_HOST=timescaledb
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=password
      - DB_NAME=${DB_NAME:-stockval}
      - REDIS_URL=redis://redis:6379/1
      - API_HUB_REDIS_URL=redis://redis:6379/15
    volumes:
      - ../src:/app/src
      - ../configs:/app/configs
      - ${BASE_PATH}/data:/app/data
    depends_on:
      - timescaledb
      - redis
      - gateway-worker-real
    networks:
      - default
    restart: always
    deploy:
      resources:
        reservations:
          memory: 256M
        limits:
          memory: 1G
    profiles:
      - real
      - verification

  # [ISSUE-037] API Gateway Worker (Mock Mode - Phase 1)
  # Council 승인: Mock Mode Only, 실제 API 호출 없음
  gateway-worker-mock:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME}-gateway-worker-mock
    command: python -m src.api_gateway.hub
    environment:
      - REDIS_URL=redis://redis:6379/15
      - ENABLE_MOCK=true
      - APP_ENV=${APP_ENV:-development}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - HUB_CONFIG_PATH=/app/configs/api_hub_v2.yaml
    volumes:
      - ../src:/app/src
      - ../configs:/app/configs
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          memory: 256M
    networks:
      - default
    profiles:
      - hub-mock
    healthcheck:
      test: [ "CMD", "pgrep", "-f", "worker" ]
      interval: 10s
      timeout: 5s
      retries: 3

  # [ISSUE-037] API Gateway Worker (Real Mode - Phase 2)
  # Production-ready with real KIS/Kiwoom API integration
  gateway-worker-real:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME}-gateway-worker-real
    command: python -m src.api_gateway.hub
    env_file:
      - ../${ENV_FILE:-.env.prod}
    environment:
      - REDIS_URL=redis://redis:6379/15
      - ENABLE_MOCK=false # Real API mode
      - APP_ENV=${APP_ENV:-production}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - HUB_CONFIG_PATH=/app/configs/api_hub_v2.yaml
      # KIS Provider
      - KIS_APP_KEY=${KIS_APP_KEY}
      - KIS_APP_SECRET=${KIS_APP_SECRET}
      - KIS_BASE_URL=${KIS_BASE_URL}
      # Kiwoom Provider
      - KIWOOM_APP_KEY=${KIWOOM_APP_KEY}
      - KIWOOM_APP_SECRET=${KIWOOM_APP_SECRET}
      - KIWOOM_API_URL=${KIWOOM_API_URL}
      # Rate Limiter
      - RATE_LIMITER_URL=redis://redis-gatekeeper:6379/0
    volumes:
      - ../src:/app/src
      - ../configs:/app/configs
    depends_on:
      redis:
        condition: service_healthy
      redis-gatekeeper:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          memory: 256M
    networks:
      - default
    profiles:
      - real
      - hub-real
    healthcheck:
      # Redis Hub (DB 15) 및 Redis Gatekeeper (DB 0) 연결 확인
      test: [ "CMD-SHELL", "python -c \"import redis; r1=redis.Redis.from_url('redis://redis:6379/15'); r1.ping(); r2=redis.Redis.from_url('redis://redis-gatekeeper:6379/0'); r2.ping(); print('healthy')\"" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

volumes:
  redis-data:
  redis-gatekeeper-data:
  timescale-data:


