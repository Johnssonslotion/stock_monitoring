# 🔍 장애 원인 분석 보고서 (Root Cause Analysis)

**일시**: 2026년 1월 6일 ~ 1월 7일
**장애 유형**: 데이터 수집 중단 (Tick Data Loss)
**핵심 원인**: Docker Compose 환경 변수 전파 실패 (Environment Injection Failure)

---

## 🏛️ Council of Personas 분석 보고

### 👔 Project Manager (PM)
> "이번 장애로 인해 1월 6일~7일 약 48시간의 고해상도 틱 데이터가 누락되었습니다. 이는 단기 시뮬레이션 및 정밀 분석 신뢰도에 영향을 줄 수 있습니다. 향후 **'Zero Data Alarm(가동 시간 0초 알람)'**을 도입하여 데이터 누락 발생 시 즉시 감지할 수 있는 프로세스를 수립하겠습니다."

### 🏛️ Architect
> "아키텍처상 `deploy/docker-compose.yml` 파일이 서브 디렉토리에 위치해 있어, 루트의 `.env` 파일을 자동으로 탐색하지 못한 시스템적 결함이 발견되었습니다. 설정 파일의 상대 경로 의존성을 제거하고 **명시적 선언(env_file)**으로 구조를 보강하여 재발을 방지했습니다."

### 🔧 Infrastructure Engineer
> "실시간 수집기 컨테이너 내부 환경을 점검한 결과, `KIS_APP_SECRET` 변수가 빈 값(Empty String)으로 주입된 것을 확인했습니다. Docker Orchestrator가 호스트 쉘의 비공개 변수를 보호하기 위해 엄격한 격리를 수행하며 발생한 문제이며, `env_file` 지시어를 통해 컨테이너 런타임에 직접 주입하는 방식으로 해결했습니다."

### 👨‍💻 Developer
> "수집기 로그에서 `secretkey는 필수입니다.`라는 KIS API 서버의 에러 응답을 포착했습니다. 이는 코드 로직의 오류가 아닌 인증 정보의 부재가 원인이었습니다. 현재는 `docker-compose.yml` 수정을 통해 모든 수집기가 정상 인증 키를 보유하고 있음을 확인했습니다."

### 🔬 Data Scientist
> "누락된 2일간의 틱 데이터는 복구가 어렵지만, `HistoryLoader`를 통해 일봉(1Day) 데이터로 보간(Interpolation)하여 분석의 연속성은 확보했습니다. 향후 데이터 파이프라인의 **Check-sum 검증**을 강화하겠습니다."

---

## 📋 타임라인 및 해결 조치

1.  **발견 (1/7 07:30)**: 대시보드 및 DB 조회 결과 1월 6~7일 틱 데이터 부재 확인.
2.  **진단 (1/7 08:20)**: `docker logs real-collector` 확인 결과, KIS API 인증 실패(Auth Failed) 로그 발견.
3.  **원인 파악 (1/7 08:25)**: 컨테이너 내부 환경 변수가 비어 있음을 `docker exec`로 확인.
4.  **조치 (1/7 08:30)**: `deploy/docker-compose.yml` 서비스 정의에 `env_file: ../.env` 명시적 추가 및 재시작.
5.  **검증 (1/7 08:45)**: 로그를 통해 **"Connected to KIS KR WebSocket"** 및 정상 구독 시작 확인.

---

## 🚀 재발 방지 대책 (Action Items)
- **[ ] Sentinel 도입**: `.ai-rules.md` Rule 7.2에 따라 데이터 0건 발생 시 알림 시스템 구축.
- **[ ] CI/CD 검증**: 환경 변수 주입 성공 여부를 체크하는 자동화된 헬스 체크 스크립트 추가.
- **[x] 설정 중앙화**: 모든 서비스의 환경 설정을 명시적 파일 매핑 방식으로 통일 (완료).

> [!IMPORTANT]
> 현재 시스템은 완벽히 복구되어 정상 수집 중입니다. 1월 8일 개장 시점부터는 누락 없는 실시간 분석이 보장됩니다.
